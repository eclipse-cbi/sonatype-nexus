#*******************************************************************************
# Copyright (c) 2023 Eclipse Foundation and others.
# This program and the accompanying materials are made available
# under the terms of the Eclipse Public License 2.0
# which is available at http://www.eclipse.org/legal/epl-v20.html,
# or the MIT License which is available at https://opensource.org/licenses/MIT.
# SPDX-License-Identifier: EPL-2.0 OR MIT
#*******************************************************************************
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ .Values.namespace }}
  name: {{ .Values.appName }}-nginx-config
data:
  default.conf: |
    # Extract repository name from URI
    map $request_uri $repo_name {
        default "";
        "~^/repository/(?<name>[^/]+)"                              $name;
        "~^/content/repositories/(?<name>[^/]+)"                    $name;
        "~^/service/rest/repository/browse/(?<name>[^/]+)"          $name;
    }

    # Extract base name (without suffix) or full name if no suffix
    map $repo_name $repo_base_or_full {
        default                           $repo_name;
        "~^(?<base>.+)-(releases|snapshots)$"  $base;
    }

    # Extract suffix (-releases/-snapshots) if exists
    map $repo_name $repo_suffix {
        default                           "";
        "~^.+-(releases)$"                "-releases";
        "~^.+-(snapshots)$"               "-snapshots";
    }

    # Map repository base names to new names
    map $repo_base_or_full $new_base {
        default                           "";
        
        # Specific mappings (suffixes are automatically handled)
        "dash-licenses"                   "dash-maven2";
        "emf-incquery"                    "incquery-maven2";
        "jax-rs-api"                      "jaxws-maven2";
        "jdtls"                           "ls-maven2";
        "orbit-approved-artifacts"        "orbit-maven2";
        "slsa-tools"                      "csi-maven2";
        "locationtech-thirdparty"         "locationtech-maven2";
        "viatra2"                         "viatra-maven2";

        # Auto-append -maven2 suffix for standard repositories
        "~^(acceleo|andmore|atl|californium|cbi|concierge|diffmerge|ditto|ebr|ecf|eclipse|eclipsefdn|eclipsescada|eef|efxclipse|egit|emf|emfcompare|emfservices|etrice|foobar|gemoc|geogig|geomesa|geotrellis|golo|hawkbit|henshin|hono|jgit|jts|jubula|kura|lemminx|leshan|linuxtools|lsp4jakarta|lsp4mp|lyo|microprofile|mosaic|mylyn|nattable|ogee|openk-platform|orion|paho|papyrus|proj4j|ptp|rcptt|recommenders|research-datamite|scout|sensinact|sfcurve|sirius|smarthome|statet|sumo|sw360|teneo|tm4e|tycho|uml2|unide|webtools|yasson)$" "$1-maven2";
    }

    # Compute final repo name: base + suffix (or just base if no suffix)
    map "$new_base:$repo_suffix" $new_repo {
        default                           "";
        "~^(?<base>[^:]+):(?<suffix>-.+)$"  "${base}${suffix}";
        "~^(?<base>[^:]+):$"              $base;
    }

    # Explicit repository name mappings (simple renames)
    map $repo_name $explicit_repo {
        default "";
        
        # Simple renames (not affected by suffix system)
        "releases"                        "maven2-releases";
        "snapshots"                       "maven2-snapshots";
        "maven_central"                   "maven-central";
        "eclipse-staging"                 "eclipse-maven2-staging";
    }

    # Choose final repo name: explicit takes priority over suffix-based
    map "$explicit_repo:$new_repo" $final_repo {
        default "";
        "~^(?<explicit>[^:]+):"          $explicit;
        "~^:(?<suffix>.+)$"              $suffix;
    }

    # Build final redirect URL
    map "$final_repo:$request_uri" $final_redirect {
        default "";
        "~^(?<new>[^:]+):/repository/[^/]+/(?<path>.*)$"                    /repository/$new/$path;
        "~^(?<new>[^:]+):/content/repositories/[^/]+/(?<path>.*)$"          /content/repositories/$new/$path;
        "~^(?<new>[^:]+):/service/rest/repository/browse/[^/]+/(?<path>.*)$" /service/rest/repository/browse/$new/$path;
    }

    server {
        listen 8080;
        server_name _;

        # Send logs to stdout/stderr for Kubernetes log collection
        access_log /dev/stdout;
        error_log /dev/stdout notice;
        rewrite_log on;

        client_max_body_size 1g;
        client_body_buffer_size 128k;

        # Rewrite URL if mapping exists
        if ($final_redirect != "") {
            rewrite ^ $final_redirect break;
        }

        location / {
            proxy_pass http://localhost:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /metrics {
            if ($http_user_agent !~* "Prometheus") {
                return 403;
            }
            vhost_traffic_status on;
            vhost_traffic_status_bypass_limit on;
            vhost_traffic_status_bypass_stats on;
            vhost_traffic_status_display;
            vhost_traffic_status_display_format prometheus;
        }
    }
